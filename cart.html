<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras - Gonzalo Juárez López Jr.</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Cinzel:wght@400;700&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Cinzel', 'serif'],
                    },
                    colors: {
                        page: '#000000',
                        card: '#121212',
                        cardHover: '#18181b',
                        borderDark: '#27272a',
                        brandPink: '#D40B75',
                        brandPinkHover: '#b00961',
                    }
                }
            }
        }
    </script>
</head>

<body
    class="m-0 p-0 w-full min-h-screen flex flex-col font-sans bg-page text-white selection:bg-brandPink selection:text-white" x-data="{ mobileMenuOpen: false }">

    <header class="w-full h-[70px] sm:h-[80px] bg-white px-4 sm:px-8 flex items-center justify-between sticky top-0 z-50 shadow-sm border-b border-gray-100">
        <a href="index.html" class="flex items-center cursor-pointer flex-shrink-0">
            <img src="images/LOGOMORADOJULG.png" alt="JULG Logo" width="40" height="40" class="object-contain sm:w-[45px] sm:h-[45px]">
            <div class="ml-2 flex flex-col justify-center">
                <span class="text-black font-serif font-bold text-[9px] sm:text-[10px] leading-none tracking-widest">GONZALO</span>
                <span class="text-black font-serif text-[7px] sm:text-[8px] leading-none tracking-wider mt-[1px]">SUÁREZ LÓPEZ JR.</span>
            </div>
        </a>

        <nav class="hidden md:flex items-center gap-8 lg:gap-10">
            <a href="index.html" class="text-xs sm:text-sm font-semibold text-black hover:text-gray-600 transition-colors">Inicio</a>
            <a href="tienda.html" class="text-xs sm:text-sm font-semibold text-black hover:text-gray-600 transition-colors">Tienda</a>
            <a href="panel.html" class="text-xs sm:text-sm font-semibold text-black hover:text-gray-600 transition-colors">Mi panel</a>
        </nav>

        <div class="flex items-center gap-2 sm:gap-4">
            <a href="login.html" class="hidden sm:block">
                <button class="px-3 sm:px-4 py-1.5 border border-black rounded-full text-xs font-medium text-black hover:bg-black hover:text-white transition-colors">Ingresar</button>
            </a>
            <a href="register.html" class="hidden sm:block">
                <button class="px-3 sm:px-4 py-1.5 bg-brandPink rounded-full text-xs font-medium text-white hover:bg-brandPinkHover transition-colors shadow-md">Iniciar sesión</button>
            </a>
            <a href="cart.html" class="flex-shrink-0">
                <button class="w-8 h-8 sm:w-9 sm:h-9 bg-brandPink rounded flex items-center justify-center hover:bg-brandPinkHover transition-colors text-white shadow-md relative">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    <span id="cart-count" class="absolute -top-1 -right-1 bg-black text-white text-[7px] sm:text-[9px] w-3.5 h-3.5 sm:w-4 sm:h-4 flex items-center justify-center rounded-full border border-white">1</span>
                </button>
            </a>
            <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden w-8 h-8 sm:w-9 sm:h-9 flex items-center justify-center rounded hover:bg-gray-100 transition-colors">
                <svg :class="{'rotate-180': mobileMenuOpen}" class="w-6 h-6 text-black transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Menú móvil desplegable -->
    <nav x-show="mobileMenuOpen" @click.outside="mobileMenuOpen = false" class="fixed md:hidden top-[70px] sm:top-[80px] left-0 right-0 bg-white border-b border-gray-200 shadow-lg z-40">
        <div class="flex flex-col p-4 sm:p-6 space-y-3">
            <a href="index.html" class="text-sm font-semibold text-black hover:text-gray-600 transition-colors py-2 px-3 hover:bg-gray-100 rounded">Inicio</a>
            <a href="tienda.html" class="text-sm font-semibold text-black hover:text-gray-600 transition-colors py-2 px-3 hover:bg-gray-100 rounded">Tienda</a>
            <a href="panel.html" class="text-sm font-semibold text-black hover:text-gray-600 transition-colors py-2 px-3 hover:bg-gray-100 rounded">Mi panel</a>
            <hr class="my-2">
            <a href="login.html" class="text-sm font-semibold text-brandPink hover:text-brandPinkHover transition-colors py-2 px-3 hover:bg-gray-100 rounded">Ingresar</a>
            <a href="register.html" class="text-sm font-semibold text-white bg-brandPink hover:bg-brandPinkHover transition-colors py-2 px-3 rounded text-center">Iniciar sesión</a>
        </div>
    </nav>

    <div class="w-full bg-[#121212] py-8 border-b border-zinc-800">
        <div class="max-w-4xl mx-auto px-4">
            <div class="flex items-center justify-between relative">
                <div class="absolute top-1/2 left-0 w-full h-[1px] bg-zinc-800 -z-0 -translate-y-[15px]"></div>

                <div class="flex flex-col items-center relative z-10 group cursor-pointer">
                    <div
                        class="w-8 h-8 rounded-full bg-brandPink flex items-center justify-center text-xs font-bold text-white shadow-[0_0_15px_rgba(212,11,117,0.6)] mb-2">
                        1</div>
                    <span class="text-[10px] font-bold text-white tracking-wide">Tu carrito</span>
                    <span class="text-[9px] text-zinc-500">Analizar producto</span>
                </div>

                <div class="flex flex-col items-center relative z-10 group">
                    <div
                        class="w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center text-xs font-bold text-zinc-500 mb-2">
                        2</div>
                    <span class="text-[10px] font-medium text-zinc-500">Cuenta</span>
                    <span class="text-[9px] text-zinc-600">Iniciar sesión</span>
                </div>

                <div class="flex flex-col items-center relative z-10 group">
                    <div
                        class="w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center text-xs font-bold text-zinc-500 mb-2">
                        3</div>
                    <span class="text-[10px] font-medium text-zinc-500">Pago</span>
                    <span class="text-[9px] text-zinc-600">Transacción</span>
                </div>

                <div class="flex flex-col items-center relative z-10 group">
                    <div
                        class="w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center text-xs font-bold text-zinc-500 mb-2">
                        4</div>
                    <span class="text-[10px] font-medium text-zinc-500">Confirmación</span>
                    <span class="text-[9px] text-zinc-600">Compra completada</span>
                </div>
            </div>
        </div>
    </div>

    <main class="flex-1 w-full max-w-6xl mx-auto py-8 sm:py-12 px-4 sm:px-6">

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-12">

            <section class="lg:col-span-2 space-y-6">

                <div class="flex items-center gap-2 mb-4">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    <h2 class="text-base sm:text-lg font-medium text-white">Tu carrito</h2>
                </div>

                <div class="border border-borderDark rounded-xl p-4 sm:p-6 min-h-[300px] flex flex-col justify-center gap-4 bg-[#121212]"
                    x-data="cartData()" x-init="loadCart()">

                    <template x-for="item in cart.items" :key="item.id">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 sm:gap-6 p-3 sm:p-4 rounded-lg hover:bg-white/5 transition-colors border border-transparent hover:border-zinc-800 group">
                            <div class="w-20 sm:w-32 h-14 sm:h-20 bg-zinc-800 rounded-lg overflow-hidden shrink-0 relative">
                                <img :src="item.product.image || 'https://images.unsplash.com/photo-1626379953822-baec19c3accd?q=80&w=2670&auto=format&fit=crop'"
                                    class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
                                    :alt="item.product.name">
                            </div>

                            <div class="flex-1 w-full">
                                <h3 class="text-xs sm:text-sm font-semibold text-white mb-1" x-text="item.product.name"></h3>
                                <p class="text-[9px] sm:text-[10px] text-zinc-500 mb-2" x-text="item.product.description.substring(0, 40)"></p>
                                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3">
                                    <span class="text-sm sm:text-base font-bold text-white" x-text="'$' + parseFloat(item.product.price).toFixed(2)"></span>
                                    <input type="number" :value="item.quantity" @change="updateQuantity(item.id, $event.target.value)"
                                        class="w-10 sm:w-12 bg-black border border-zinc-700 rounded px-2 py-1 text-xs text-white text-center">
                                    <span class="text-[9px] sm:text-[10px] text-zinc-500" x-text="'Subtotal: $' + (item.product.price * item.quantity).toFixed(2)"></span>
                                </div>
                            </div>

                            <button @click="removeItem(item.id)"
                                class="text-zinc-500 hover:text-brandPink transition-colors p-2 rounded-full hover:bg-brandPink/10 shrink-0">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                        </div>
                    </template>

                    <div x-show="loading" class="text-center py-8">
                        <p class="text-zinc-400 text-sm">Cargando carrito...</p>
                    </div>

                    <div x-show="!loading && cart.items.length === 0" class="text-center py-8">
                        <p class="text-zinc-400 text-sm mb-4">Tu carrito está vacío</p>
                        <a href="tienda.html" class="text-brandPink hover:underline text-xs sm:text-sm">Continuar comprando</a>
                    </div>

                </div>

            </section>

            <section class="lg:col-span-1" x-data="cartData()" x-init="loadCart()">
                <div class="sticky top-20 border border-borderDark rounded-xl p-4 sm:p-6 bg-[#121212]">
                    <h2 class="text-sm sm:text-base font-medium text-white mb-4 sm:mb-6 pb-3 sm:pb-4 border-b border-zinc-800">Resumen del pedido</h2>

                    <div class="space-y-2 sm:space-y-3 mb-4 sm:mb-6">
                        <div class="flex justify-between text-xs">
                            <span class="text-zinc-400">Subtotal</span>
                            <span class="text-white font-medium" x-text="'$' + (cart.subtotal || 0).toFixed(2)"></span>
                        </div>
                        
                        <div x-show="cart.discount > 0" class="flex justify-between text-xs">
                            <span class="text-brandPink">Descuento</span>
                            <span class="text-brandPink font-medium" x-text="'-$' + (cart.discount || 0).toFixed(2)"></span>
                        </div>
                    </div>

                    <div class="border-t border-zinc-800 my-3 sm:my-4"></div>

                    <div class="flex justify-between items-end mb-4 sm:mb-6">
                        <span class="text-xs sm:text-sm font-semibold text-white">Total</span>
                        <div class="text-right">
                            <span class="text-lg sm:text-xl font-bold text-white" x-text="'$' + (cart.total || 0).toFixed(2)"></span>
                        </div>
                    </div>
                    
                    <div class="mb-4 flex gap-1 sm:gap-2 flex-col sm:flex-row">
                        <input type="text" id="coupon-input" placeholder="Código de cupón" 
                            class="flex-1 bg-black border border-zinc-700 rounded px-2 sm:px-3 py-2 text-xs text-white placeholder-zinc-600">
                        <button @click="applyCoupon()" class="px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-xs font-medium text-white transition-colors w-full sm:w-auto">
                            Aplicar
                        </button>
                    </div>

                    <button @click="checkout()" :disabled="!isLoggedIn() || cart.items.length === 0"
                        class="w-full bg-gradient-to-r from-brandPink to-[#9c0856] hover:from-[#b00961] hover:to-[#7a0643] disabled:opacity-50 disabled:cursor-not-allowed text-white py-2.5 sm:py-3 rounded-lg text-xs sm:text-sm font-bold tracking-wide shadow-lg shadow-pink-900/20 flex items-center justify-center gap-2 transition-all transform hover:scale-[1.02]"
                        x-text="!isLoggedIn() ? 'Inicia sesión para comprar' : cart.items.length === 0 ? 'Carrito vacío' : 'Proceder al pago'">
                        Proceder al pago
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <path d="M5 12h14"></path>
                            <path d="M12 5l7 7-7 7"></path>
                        </svg>
                    </button>

                    <div x-show="error" class="mt-3 sm:mt-4 text-red-500 text-xs text-center" x-text="error"></div>

                </div>
            </section>
        </div>

        <section class="mt-12 sm:mt-20 border-t border-zinc-900 pt-8 sm:pt-10">
            <h3 class="text-xs sm:text-sm font-bold text-white mb-4 sm:mb-6">Cursos recomendados para ti</h3>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
                <div
                    class="aspect-video border border-zinc-800 rounded-lg bg-zinc-900/30 hover:bg-zinc-900 hover:border-zinc-700 transition-all cursor-pointer group relative overflow-hidden">
                    <div
                        class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-xs font-medium text-brandPink">Ver curso</span>
                    </div>
                </div>
                <div
                    class="aspect-video border border-zinc-800 rounded-lg bg-zinc-900/30 hover:bg-zinc-900 hover:border-zinc-700 transition-all cursor-pointer group relative overflow-hidden">
                    <div
                        class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-xs font-medium text-brandPink">Ver curso</span>
                    </div>
                </div>
                <div
                    class="aspect-video border border-zinc-800 rounded-lg bg-zinc-900/30 hover:bg-zinc-900 hover:border-zinc-700 transition-all cursor-pointer group relative overflow-hidden">
                    <div
                        class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-xs font-medium text-brandPink">Ver curso</span>
                    </div>
                </div>
                <div
                    class="aspect-video border border-zinc-800 rounded-lg bg-zinc-900/30 hover:bg-zinc-900 hover:border-zinc-700 transition-all cursor-pointer group relative overflow-hidden">
                    <div
                        class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-xs font-medium text-brandPink">Ver curso</span>
                    </div>
                </div>
            </div>
        </section>

    </main>

    
</body>

<script type="module">
    import * as API from './api.module.js';
    window.API = API;
    
    // Define cartData DESPUÉS de que window.API esté disponible
    window.cartData = function() {
        return {
            cart: { items: [], total: 0, discountAmount: 0, subtotal: 0, tax: 0, shipping: 0, appliedCoupon: null },
            loading: true,
            error: '',
            isLoggedIn() {
                return isLoggedIn();
            },
            async loadCart() {
                try {
                    if (!window.API) throw new Error('API no cargada');
                    const data = await window.API.apiGetCart();
                    this.cart = {
                        items: data.items || [],
                        total: data.total || 0,
                        discountAmount: data.discountAmount || 0,
                        subtotal: data.subtotal || 0,
                        tax: data.tax || 0,
                        shipping: data.shipping || 0,
                        appliedCoupon: data.appliedCoupon || null,
                        discount: data.discountAmount || 0,
                        isAnonymous: data.isAnonymous || false
                    };
                    try {
                        const total = this.cart.items.reduce((acc,it)=>acc+it.quantity,0);
                        const el = document.getElementById('cart-count');
                        if (el) el.textContent = total;
                    } catch(e) {}
                } catch (err) {
                    console.error('Error loading cart:', err);
                } finally {
                    this.loading = false;
                }
            },
            async updateQuantity(itemId, newQuantity) {
                try {
                    const quantity = parseInt(newQuantity);
                    if (quantity <= 0) {
                        await this.removeItem(itemId);
                        return;
                    }
                    await window.API.apiUpdateCartItem(itemId, quantity);
                    await this.loadCart();
                } catch (err) {
                    this.error = err.message;
                }
            },
            async removeItem(itemId) {
                try {
                    await window.API.apiRemoveFromCart(itemId);
                    await this.loadCart();
                } catch (err) {
                    this.error = err.message;
                }
            },
            async applyCoupon() {
                try {
                    this.error = '';
                    const code = document.getElementById('coupon-input').value.trim();
                    if (!code) {
                        this.error = 'Ingresa un código de cupón';
                        return;
                    }
                    const result = await window.API.apiApplyCoupon(code);
                    // El backend devuelve { ok: true, message: '...' }
                    if (result.ok || result.success) {
                        this.error = 'Cupón aplicado: ' + (result.message || '');
                        document.getElementById('coupon-input').value = '';
                        await this.loadCart();
                    } else {
                        this.error = result.message || 'Cupón inválido';
                    }
                } catch (err) {
                    this.error = err.message || 'Error al aplicar cupón';
                }
            },
            async checkout() {
                try {
                    this.error = '';
                    
                    // Si es anónimo, redirigir a login
                    if (this.cart.isAnonymous) {
                        window.location.href = 'login.html?redirect=cart';
                        return;
                    }
                    
                    if (this.cart.items.length === 0) {
                        this.error = 'El carrito está vacío';
                        return;
                    }
                    // Mostrar formulario de envío simple
                    const shippingInfo = {
                        address: prompt('Dirección de envío:') || '',
                        city: prompt('Ciudad:') || '',
                        postalCode: prompt('Código postal:') || ''
                    };
                    if (!shippingInfo.address || !shippingInfo.city) {
                        this.error = 'Información de envío incompleta';
                        return;
                    }
                    const order = await window.API.apiCreateOrder(shippingInfo);
                    // El backend devuelve { ok: true, orderId: ... }
                    if (order.ok || order.success) {
                        alert('¡Pedido creado! Número de orden: ' + order.orderId);
                        window.location.href = 'panel.html?section=orders';
                    } else {
                        this.error = order.message || 'Error al crear la orden';
                    }
                } catch (err) {
                    // Si el error es "Inicia sesión", redirigir a login
                    if (err.message.includes('Inicia sesión')) {
                        window.location.href = 'login.html?redirect=cart';
                    } else {
                        this.error = err.message || 'Error al crear la orden';
                    }
                }
            }
        }
    }
</script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="./api.umd.js"></script>
<script>
    // Listen for storage changes and reload cart
    window.addEventListener('storage', async (e) => {
        if (e.key === 'carts' || e.key === 'currentUser') {
            try {
                const data = await window.API.apiGetCart();
                const total = data.items.reduce((acc, it) => acc + it.quantity, 0);
                const el = document.getElementById('cart-count');
                if (el) el.textContent = total;
            } catch (err) {
                console.error('Error updating cart count:', err);
            }
        }
    })
</script>

</html>